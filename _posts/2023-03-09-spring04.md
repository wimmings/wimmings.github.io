---
title:  "[Spring] 5ì¥ Spring Securityì™€ OAuth 2.0ìœ¼ë¡œ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°" 


categories: springstudy
toc: true
toc_sticky: true
tags: spring oauth
date: 2023-03-09
last_modified_at: 2024-03-25
---
# 5ì¥ - Spring Securityì™€ OAuth 2.0ìœ¼ë¡œ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„í•´ë³´ì!

Spring Security : ë§‰ê°•í•œ ì¸ì¦ê³¼ ê¶Œí•œ ë¶€ì—¬ ê¸°ëŠ¥ì„ ê°€ì§„ í”„ë ˆì„ì›Œí¬

> âœ”ï¸ğŸ‘‰ğŸ» [OAuth 2.0 ë™ì‘ ë°©ì‹ì˜ ì´í•´](https://blog.naver.com/mds_datasecurity/222182943542){: target="_blank"}  

## 5.1 Spring Securityì™€ Spring Security Oauth2 í´ë¼ì´ì–¸íŠ¸
- OAuth ë¡œê·¸ì¸ êµ¬í˜„ì‹œ ë¡œê·¸ì¸ ë³´ì•ˆ, ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°, ë³€ê²½ ë“±ì„ ëª¨ë‘ êµ¬ê¸€, í˜ì´ìŠ¤ë¶, ë„¤ì´ë²„ ë“±ì— ë§¡ê¸°ë©´ ëœë‹¤!

## 5.2 êµ¬ê¸€ ì„œë¹„ìŠ¤ ë“±ë¡

### 5.2.1 í”„ë¡œì íŠ¸ ìƒì„± í›„ ë™ì˜ í™”ë©´ êµ¬ì„±
OAuth ë™ì˜ í™”ë©´ êµ¬ì„± ì¤‘ `Google API`ì˜ ë²”ìœ„?  
ì´ë²ˆì— ë“±ë¡í•  êµ¬ê¸€ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•  ë²”ìœ„ ëª©ë¡ì´ë‹¤.  
ê¸°ë³¸ê°’ì€ `email`, `profile`, `openid` ì´ë©° ì´ì™¸ ë‹¤ë¥¸ ì •ë³´ë“¤ë„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ë²”ìœ„ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ !
<img width="1023" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2022-12-02 á„‹á…©á„’á…® 2 45 56" src="https://github.com/wimmings/wimmings/assets/98014840/5fc67068-fe75-405c-b8ff-a1c4fde2569c">

<br>

### 5.2.2 OAuth í´ë¼ì´ì–¸íŠ¸ ID ë§Œë“¤ê¸°
<img width="841" alt="2" src="https://github.com/wimmings/wimmings/assets/98014840/62993b81-8e0d-4fe5-ad38-fa8944c60f64">

> ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI

- ì„œë¹„ìŠ¤ì—ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì¸ì¦ ì •ë³´ë¥¼ ì¤¬ì„ ë•Œ ***`ì¸ì¦ì´ ì„±ê³µí•˜ë©´ êµ¬ê¸€ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í• `*** URLì´ë‹¤.
- `spring boot 2` ë²„ì „ì˜ `security`ì—ì„  ê¸°ë³¸ì ìœ¼ë¡œ  
`{ë„ë©”ì¸}/login/oauth2/code/{ì†Œì…œì„œë¹„ìŠ¤ì½”ë“œ}` ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì§€ì›í•˜ê³  ìˆë‹¤.
- ì‚¬ìš©ìê°€ ë³„ë„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì§€ì›í•˜ëŠ” `Controller`ë¥¼ ë§Œë“¤ í•„ìš” âŒ
- AWS ì„œë²„ì— ë°°í¬í•˜ê²Œ ë˜ë©´, localhost ì™¸ì— `ì¶”ê°€ë¡œ` ì£¼ì†Œë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤. -> ì¶”í›„!


ìƒì„± í›„ `clientId` ì™€ `clientSecret` ì½”ë“œë¥¼ ë³µì‚¬í•´ í”„ë¡œì íŠ¸ì—ì„œ ì„¤ì •í•˜ì

### 5.2.3 application-oauth.properties íŒŒì¼ ìƒì„± 
```properties
spring.security.oauth2.client.registration.google.client-id=í´ë¼ì´ì–¸íŠ¸ ID
spring.security.oauth2.client.registration.google.client-secret=í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ ë¹„ë°€
spring.security.oauth2.client.registration.google.scope=profile, email
```

- ê°•ì œë¡œ `profile`, `email`ì„ ë“±ë¡í•œ ì´ìœ ëŠ” `openid`ë¼ëŠ” `scope`ì´ ìˆìœ¼ë©´ `Open Id Provider`ë¡œ ì¸ì‹,  
=> ê·¸ëŸ¬ë©´ OpenId Providerì¸ ì„œë¹„ìŠ¤(êµ¬ê¸€)ì™€ `ê·¸ë ‡ì§€ ì•Šì€` ì„œë¹„ìŠ¤(ë„¤ì´ë²„ ì¹´ì¹´ì˜¤)ë¡œ ë‚˜ëˆ ì„œ `ê°ê° OAuth2Service`ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

- `properties`ì˜ ì´ë¦„ì„ ***`application-xxx.properties`*** ë¡œ ë§Œë“¤ë©´ ***`profile=xxx`*** ë¼ëŠ” ì‹ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬  
í•´ë‹¹ í”„ë¡œí¼í‹°ì˜ ì„¤ì •ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- í˜¸ì¶œí•˜ëŠ” ë°©ì‹ì€ ì—¬ëŸ¬ ë°©ì‹ì´ ìˆì§€ë§Œ ì´ ì±…ì—ì„œëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ê¸°ë³¸ ì„¤ì • íŒŒì¼ì¸ 
`application.properties`ì—ì„œ `application-oauth.properties`ë¥¼ í¬í•¨í•˜ë„ë¡ êµ¬ì„±!

<br>

`application.properties`ì— ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì

```properties
spring.profiles.include=oauth
```

ğŸ”¥Â `í´ë¼ì´ì–¸íŠ¸ ID`ì™€ `í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ ë¹„ë°€`ì€ ë³´ì•ˆì´ ì¤‘ìš”í•œ ì •ë³´!  
`.gitignore`ì— 
`application-oauth.properties`ë¥¼ ì¶”ê°€í•˜ì

<br>

## 5.3 êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ë™í•˜ê¸°

### 5.3.1 domain/user/User í´ë˜ìŠ¤ ìƒì„±

ğŸ‘‡ğŸ» ì²˜ìŒ ë³´ëŠ” ë¶€ë¶„!! <br>
``` @Enumerated(EnumType.STRING) ```
- JPAë¡œ DBì— ì €ì¥í•  ë•Œ `Enum` ê°’ì„ `ì–´ë–¤ í˜•íƒœ`ë¡œ ì €ì¥í• ì§€!
- `ìˆ«ì`ë¡œ ì €ì¥ë˜ë©´ DBë¡œ í™•ì¸í•  ë•Œ ê·¸ ê°’ì´ ë¬´ìŠ¨ ì½”ë“œë¥¼ ì˜ë¯¸í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ë‹¤! ê·¸ë˜ì„œ `ë¬¸ìì—´`ë¡œ ì €ì¥ë  ìˆ˜ ìˆë„ë¡
- `Converter`ë¡œë„ í•  ìˆ˜ ìˆìŒ

<br>

### 5.3.2 Enum í´ë˜ìŠ¤ Role ìƒì„± : ê° ì‚¬ìš©ìì˜ ê¶Œí•œ ê´€ë¦¬

```java
@Getter
@RequiredArgsConstructor
public enum Role {

    GUEST("ROLE_GUEST", "ì†ë‹˜"),
    USER("ROLE_USER", "ì¼ë°˜ ì‚¬ìš©ì");

    private final String key;
    private final String title;
}
```

`spring security` ì—ì„œëŠ” ê¶Œí•œ ì½”ë“œì— í•­ìƒ ```ROLE_```ì´ ì•ì— ìˆì–´ì•¼ í•œë‹¤.  
ê·¸ë˜ì„œ ì½”ë“œë³„ í‚¤ ê°’ì„ ```ROLE_GUEST```, ```ROLE_USER``` ë“±ìœ¼ë¡œ ì§€ì •í•œë‹¤

<br>

### 5.3.3 UserRepository : Userì˜ CRUDë¥¼ ì±…ì„ì§„ë‹¤!
```java
public interface UserRepository extends JpaRepository<User, Long> {
    
    Optional<User> findByEmail(String email);
}
```
```findByEmail``` : ì†Œì…œ ë¡œê·¸ì¸ìœ¼ë¡œ ë°˜í™˜ë˜ëŠ” ê°’ ì¤‘ `email`ì„ í†µí•´ ì´ë¯¸ ìƒì„±ëœ ì‚¬ìš©ìì¸ì§€ ì²˜ìŒ ê°€ì…í•œ ì‚¬ìš©ìì¸ì§€ íŒë‹¨í•˜ê¸° ìœ„í•œ ë©”ì†Œë“œ

### 5.3.4 build.gradleì— spring security ê´€ë ¨ ì˜ì¡´ì„± ì¶”ê°€

```gradle
implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
```  
ì†Œì…œ ë¡œê·¸ì¸ ë“± í´ë¼ì´ì–¸íŠ¸ ì…ì¥ì—ì„œ ì†Œì…œ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ í•„ìš”í•œ ì˜ì¡´ì„±

<br>

### 5.3.5 SecurityConfig í´ë˜ìŠ¤ ì‘ì„±

```java
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    private final CustomOAuth2UserService customOAuth2UserService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .csrf().disable()
                .headers().frameOptions().disable()
                .and()
                    .authorizeRequests()
                    .antMatchers("/", "/css/**", "/images/**", "/js/**", "/h2-console/**").permitAll()
                    .antMatchers("/api/v1/**").hasRole(Role.USER.name())
                    .anyRequest().authenticated()
                .and()
                    .logout()
                        .logoutSuccessUrl("/")
                .and()
                    .oauth2Login()
                        .userInfoEndpoint()
                            .userService(customOAuth2UserService);
    }
}
```
- **`@EnableWebSecurity`** : Spring Security ì„¤ì •ë“¤ì„ í™œì„±í™”ì‹œì¼œì¤€ë‹¤.
- **`.csrf().disable().headers().frameOptions().disable()`**
    - `h2-console` í™”ë©´ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•´ë‹¹ ì˜µì…˜ë“¤ì„ disable í•œë‹¤.
- **`authorizeRequests`**
    - URL ë³„ ê¶Œí•œ ê´€ë¦¬ë¥¼ ì„¤ì •í•˜ëŠ” ì˜µì…˜ì˜ `ì‹œì‘ì `
    - authorizeRequests ê°€ ì„ ì–¸ë˜ì–´ì•¼ë§Œ antMatchers ì˜µì…˜ ì‚¬ìš© ê°€ëŠ¥
- **`antMatchers`**
    - ê¶Œí•œ ê´€ë¦¬ ëŒ€ìƒì„ ì§€ì •í•˜ëŠ” ì˜µì…˜, URL, HTTP ë©”ì†Œë“œ ë³„ë¡œ ê´€ë¦¬ ê°€ëŠ¥
    - â€œ/â€ ë“± ì§€ì •ëœ URLë“¤ì€ `permitAll()` ì˜µì…˜ì„ í†µí•´ ì „ì²´ ì—´ëŒ ê¶Œí•œ ì¤€ë‹¤
    - `â€œ/api/v1/**â€` ì£¼ì†Œë¥¼ ê°€ì§„ APIëŠ” USER ê¶Œí•œì„ ê°€ì§„ ì‚¬ëŒë§Œ ê°€ëŠ¥í•˜ë„ë¡
- **`anyRequest`**
    - ì„¤ì •ëœ ê°’ ì´ì™¸ì˜ ë‚˜ë¨¸ì§€ URLì„ ë‚˜íƒ€ëƒ„
    - ì—¬ê¸°ì„  `authenticated()`ë¥¼ ì¶”ê°€í•´ ë‚˜ë¨¸ì§€ URLë“¤ì€ ëª¨ë‘ ì¸ì¦ëœ ì‚¬ìš©ìë“¤(ë¡œê·¸ì¸í•œ ì‚¬ìš©ì) ì—ê²Œë§Œ í—ˆìš©í•˜ê²Œ í•¨
- **`logout().logoutSuccessUrl(â€/â€)`**
    - ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì— ëŒ€í•œ ì—¬ëŸ¬ ì„¤ì •ì˜ ì§„ì…ì 
    - ë¡œê·¸ì•„ì›ƒ ì„±ê³µì‹œ `/` ì£¼ì†Œë¡œ ì´ë™
- **`oauth2Login`** : OAuth 2 ë¡œê·¸ì¸ ê¸°ëŠ¥ì— ëŒ€í•œ ì—¬ëŸ¬ ì„¤ì •ì˜ ì§„ì…ì 
- **`userInfoEndpoint`** : OAuth 2 ë¡œê·¸ì¸ ì„±ê³µ ì´í›„ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ë•Œì˜ ì„¤ì • ë‹´ë‹¹
- **`userService`**
    - ì†Œì…œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í›„ì† ì¡°ì¹˜ë¥¼ ì§„í–‰í•  `UserService ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´`ë¥¼ ë“±ë¡
    - ë¦¬ì†ŒìŠ¤ ì„œë²„(ì¦‰, ì†Œì…œ ì„œë¹„ìŠ¤ë“¤)ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ìƒíƒœì—ì„œ ì¶”ê°€ë¡œ ì§„í–‰í•˜ê³ ì í•˜ëŠ” ê¸°ëŠ¥ì„ ëª…ì‹œí•  ìˆ˜ ìˆìŒ.

<br>

> [ğŸ”¥ WebSecurityConfigurerAdapter deprecated ì´ìŠˆ](https://velog.io/@pjh612/Deprecated%EB%90%9C-WebSecurityConfigurerAdapter-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8C%80%EC%B2%98%ED%95%98%EC%A7%80){: target="_blank"}  

<br>

### 5.3.6 CustomOAuth2UserService í´ë˜ìŠ¤
êµ¬ê¸€ ë¡œê·¸ì¸ ì´í›„ ê°€ì ¸ì˜¨ ì‚¬ìš©ìì˜ ì •ë³´(email, name, picture)ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ,  
`ê°€ì…` ë° `ì •ë³´ ìˆ˜ì •`, `ì„¸ì…˜ ì €ì¥` ë“±ì˜ ê¸°ëŠ¥ ì§€ì›
```java
@RequiredArgsConstructor
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    private final UserRepository userRepository;
    private final HttpSession httpSession;

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2UserService<OAuth2UserRequest, OAuth2User> delegate = new DefaultOAuth2UserService();

        OAuth2User oAuth2User = delegate.loadUser(userRequest);

        String registrationId = userRequest.getClientRegistration().getRegistrationId();

        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();

        OAuthAttributes attributes = OAuthAttributes.of(registrationId, userNameAttributeName, oAuth2User.getAttributes());

        User user = saveOrUpdate(attributes);

        httpSession.setAttribute("user", new SessionUser(user));

        return new DefaultOAuth2User(
                Collections.singleton(new SimpleGrantedAuthority(user.getRoleKey())),
                                        attributes.getAttributes(),
                                        attributes.getNameAttributeKey());
    }

    private User saveOrUpdate(OAuthAttributes attributes) {

        User user = userRepository.findByEmail(attributes.getEmail())
                .map(entity -> entity.update(attributes.getName(), attributes.getPicture()))
                .orElse(attributes.toEntity());

        return userRepository.save(user);
    }
}
```
- **`registrationId`**
    - í˜„ì¬ ë¡œê·¸ì¸ ì§„í–‰ì¤‘ì¸ ì„œë¹„ìŠ¤ë¥¼ êµ¬ë¶„í•˜ëŠ” ì½”ë“œ
    - ì§€ê¸ˆì€ `êµ¬ê¸€`ë§Œ ì‚¬ìš©í•˜ëŠ” ë¶ˆí•„ìš”í•œ ê°’ì´ì§€ë§Œ, ì´í›„ `ë„¤ì´ë²„` ë¡œê·¸ì¸ ì—°ë™ ì‹œì— ë„¤ì´ë²„ ë¡œê·¸ì¸ì¸ì§€, êµ¬ê¸€ ë¡œê·¸ì¸ì¸ì§€ `êµ¬ë¶„í•  ë•Œ ì‚¬ìš©`
- **`userNameAttributeName`**
    - OAuth2 ë¡œê·¸ì¸ ì§„í–‰ ì‹œ í‚¤ê°€ ë˜ëŠ” í•„ë“œê°’! `Primary Key`ì™€ ê°™ì€ ì˜ë¯¸
    - `êµ¬ê¸€`ì˜ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ì½”ë“œë¥¼ ì§€ì›, ê¸°ë³¸ ì½”ë“œëŠ” `"sub"`ì´ë©° `ë„¤ì´ë²„, ì¹´ì¹´ì˜¤` ë“±ì€ ê¸°ë³¸ ì§€ì›í•˜ì§€ âŒ
    - ì´í›„ ë„¤ì´ë²„ ë¡œê·¸ì¸ê³¼ êµ¬ê¸€ ë¡œê·¸ì¸ì„ `ë™ì‹œ ì§€ì›í•  ë•Œ ì‚¬ìš©`
- **`OAuthAttributes í´ë˜ìŠ¤`**
    - OAuth2UserServiceë¥¼ í†µí•´ ê°€ì ¸ì˜¨ `OAuth2Userì˜ attribute`ë¥¼ ë‹´ì„ í´ë˜ìŠ¤, ì´í›„ ë„¤ì´ë²„ ë“± ë‹¤ë¥¸ ì†Œì…œ ë¡œê·¸ì¸ë„ ì´ í´ë˜ìŠ¤ ì‚¬ìš©
- **`SessionUser í´ë˜ìŠ¤`**
    - ì„¸ì…˜ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ `Dto í´ë˜ìŠ¤`
    - :question: **ì™œ User í´ë˜ìŠ¤ë¥¼ ì“°ì§€ ì•Šê³  ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ì“¸ê¹Œ :question:**  
        ğŸš¨ Userì„ ì¼ì„ ë•Œì˜ ì—ëŸ¬ : User í´ë˜ìŠ¤ì— `ì§ë ¬í™”`ë¥¼ êµ¬í˜„í•˜ì§€ ì•Šì•˜ë‹¤ëŠ” ì—ëŸ¬  
        â†’ User í´ë˜ìŠ¤ê°€ `ì—”í‹°í‹°`ì´ê¸° ë•Œë¬¸ì— ì–¸ì œ `ë‹¤ë¥¸ ì—”í‹°í‹°`ì™€ ê´€ê³„ê°€ í˜•ì„±ë ì§€ ëª¨ë¥¸ë‹¤.  
        â†’ ì„±ëŠ¥ì´ìŠˆ, ë¶€ìˆ˜íš¨ê³¼ê°€ ë°œìƒ  
        â†’ ê·¸ë˜ì„œ `ì§ë ¬í™” ê¸°ëŠ¥ì„ ê°€ì§„` `ì„¸ì…˜ Dto SessionUser`ë¥¼ í•˜ë‚˜ ì¶”ê°€ë¡œ ë§Œë“œëŠ” ê²ƒì´ ë‚«ë‹¤  


<br>

### 5.3.7 OAuthAttribute í´ë˜ìŠ¤

```java
public static OAuthAttributes of(String registrationId, String userNameAttributeName, Map<String, Object> attributes) {
    return ofGoogle(userNameAttributeName, attributes);
}

private static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
    return OAuthAttributes.builder()
            .name((String) attributes.get("name"))
            .email((String) attributes.get("email"))
            .picture((String) attributes.get("picture"))
            .attributes(attributes)
            .nameAttributeKey(userNameAttributeName)
            .build();
}

public User toEntity() {
    return User.builder()
            .name(name)
            .email(email)
            .picture(picture)
            .role(Role.GUEST)
            .build();
}
```
- **`of`**
    - OAuth2Userì—ì„œ ë°˜í™˜í•˜ëŠ” ì‚¬ìš©ì ì •ë³´ëŠ” `Map` ì´ê¸° ë•Œë¬¸ì— ê°’ í•˜ë‚˜í•˜ë‚˜ë¥¼ ë³€í™˜í•´ì•¼ í•¨
- **`toEntity()`**
    - User ì—”í‹°í‹° ìƒì„±
    - OAuthAttributesì—ì„œ ì—”í‹°í‹°ë¥¼ `ìƒì„±í•˜ëŠ”` ì‹œì ì€ `ì²˜ìŒ ê°€ì…í•  ë•Œ!`
    - ê°€ì…í•  ë•Œì˜ `ê¸°ë³¸ ê¶Œí•œ`ì„ `GUEST`ë¡œ ì£¼ê¸° ìœ„í•´ì„œ `role ë¹Œë”ê°’`ì—ëŠ” `Role.GUEST` ì‚¬ìš©

<br>

### 5.3.8 SessionUser í´ë˜ìŠ¤ : config.auth.dto íŒ¨í‚¤ì§€ì—
```java
@Getter
public class SessionUser implements Serializable {
    private String name;
    private String email;
    private String picture;

    public SessionUser(User user) {
        this.name = user.getName();
        this.email = user.getEmail();
        this.picture = user.getPicture();
    }
}
```
`SessionUser`ì—ì„œëŠ” `ì¸ì¦ëœ` ì‚¬ìš©ì ì •ë³´ë§Œ í•„ìš”  
â†’ `name, email, picture`ë§Œ í•„ë“œë¡œ ì„ ì–¸
<br>   
âœ…Â ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

<br>

## 5.4 ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ìœ¼ë¡œ ê°œì„ í•˜ê¸°
ì•ì„œ ë§Œë“  ì½”ë“œì—ì„œ ê°œì„ í•  ë¶€ë¶„ì„ ì°¾ì•„ë³´ì!

> `IndexController` ì—ì„œ ì„¸ì…˜ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„!

```java
SessionUser user = (SessionUser) httpSession.getAttribute("user");
```

`index` ë©”ì†Œë“œ ì™¸ì— ë‹¤ë¥¸ ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ë©”ì†Œë“œì—ì„œ ì„¸ì…˜ê°’ì´ í•„ìš”í•˜ë©´ ì§ì ‘ ì„¸ì…˜ì—ì„œ ê°’ì„ ê°€ì ¸ì™€ì•¼ í•œë‹¤..
-> `ë©”ì†Œë“œ ì¸ì`ë¡œ ì„¸ì…˜ê°’ì„ ë°”ë¡œ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•˜ì!

<<<<<<< HEAD
- `config.auth` íŒ¨í‚¤ì§€ì— `@LoginUser` ì–´ë…¸í…Œì´ì…˜ì„ ìƒì„±í•œë‹¤
=======
- `config.auth` íŒ¨í‚¤ì§€ì— @LoginUser ì–´ë…¸í…Œì´ì…˜ì„ ìƒì„±í•œë‹¤
>>>>>>> ddaf2658e7257b0b6536d7387f09ff105b09da4e

```java
@Target(ElementType.PARAMETER) 
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginUser {
}
```
- **`@Target`** : ì´ ì–´ë…¸í…Œì´ì…˜ì´ ìƒì„±ë  ìˆ˜ ìˆëŠ” ìœ„ì¹˜ë¥¼ ì§€ì •, `PARAMETER`ë¡œ ì§€ì •í–ˆìœ¼ë‹ˆ ë©”ì†Œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ì„ ì–¸ëœ ê°ì²´ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥ â­•ï¸ (ì´ ì™¸ì—ë„ í´ë˜ìŠ¤ ì„ ì–¸ë¬¸ì— ì“¸ ìˆ˜ ìˆëŠ” `TYPE`ì´ ìˆìŒ)
- **`interface`** : ì´ íŒŒì¼ì„ ì–´ë…¸í…Œì´ì…˜ í´ë˜ìŠ¤ë¡œ ì§€ì •

<br>

ê°™ì€ ìœ„ì¹˜ì— `LoginUserArgumentResolver` ìƒì„±  
ì´ëŠ” `HandlerMethodArgumentResolver` ì¸í„°í˜ì´ìŠ¤ì˜ `êµ¬í˜„ì²´`!  
- ê¸°ëŠ¥ : ì¡°ê±´ì— ë§ëŠ” ê²½ìš° ë©”ì†Œë“œê°€ ìˆë‹¤ë©´ ê·¸ `êµ¬í˜„ì²´`ê°€ ì§€ì •í•œ ê°’ìœ¼ë¡œ í•´ë‹¹ ë©”ì†Œë“œì˜ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ ìˆ˜ â­•ï¸

```java
@RequiredArgsConstructor
@Component
public class LoginUserArgumentResolver implements HandlerMethodArgumentResolver {

    private final HttpSession httpSession;

    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        boolean isLoginUserAnnotation = parameter.getParameterAnnotation(LoginUser.class) != null;
        boolean isUserClass = SessionUser.class.equals(parameter.getParameterType());

        return isLoginUserAnnotation && isUserClass;
    }
```

`ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œ`ì˜ `íŠ¹ì • íŒŒë¼ë¯¸í„°`ë¥¼ ì§€ì›í•˜ëŠ”ì§€ íŒë‹¨  
ì—¬ê¸°ì„  íŒŒë¼ë¯¸í„°ì— `@LoginUser` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì–´ìˆê³ , `íŒŒë¼ë¯¸í„° í´ë˜ìŠ¤` íƒ€ì…ì´ `SessionUser.class` ì¸ ê²½ìš° true ë°˜í™˜

<br>

```java
    @Override
    public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {
        return httpSession.getAttribute("user");
    }
}
```

`íŒŒë¼ë¯¸í„°ì— ì „ë‹¬`í•  ê°ì²´ë¥¼ ìƒì„±í•œë‹¤!  
ì—¬ê¸°ì„  `ì„¸ì…˜`ì—ì„œ ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.  

---

ì´ë ‡ê²Œ ìƒì„±ëœ `LoginUserArgumentResolver`ê°€ ìŠ¤í”„ë§ì—ì„œ ì¸ì‹ë  ìˆ˜ ìˆë„ë¡  
`WebMvcConfigure`ì— ì¶”ê°€í•˜ì  
`config`ì— `WebConfig í´ë˜ìŠ¤`ë¥¼ ìƒì„±í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •ì„ ì¶”ê°€í•´ì£¼ì!

```java
@RequiredArgsConstructor
@Configuration
public class WebConfig implements WebMvcConfigurer {
    private final LoginUserArgumentResolver loginUserArgumentResolver;

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> argumentResolvers) {
        argumentResolvers.add(loginUserArgumentResolver);
    }
<<<<<<< HEAD
=======

>>>>>>> ddaf2658e7257b0b6536d7387f09ff105b09da4e
}
```
`HandlerMethodArgumentResolver` ëŠ” í•­ìƒ `WebMvcConfigurer` ì˜ `addArgumentResolvers()` ë¥¼ í†µí•´ ì¶”ê°€í•´ì•¼ í•œë‹¤!

----

<<<<<<< HEAD
ì´ì œ ì§„ì§œ `@LoginUser` ë¥¼ ì¨ì„œ ë°˜ë³µë˜ëŠ” ì½”ë“œë¥¼ ê°œì„ í•´ë³´ì
=======
ì´ì œ ì§„ì§œ @LoginUser ë¥¼ ì¨ì„œ ë°˜ë³µë˜ëŠ” ì½”ë“œë¥¼ ê°œì„ í•´ë³´ì
>>>>>>> ddaf2658e7257b0b6536d7387f09ff105b09da4e
```java
    @GetMapping("/")
    public String index(Model model, @LoginUser SessionUser user) {
        model.addAttribute("posts", postsService.findAllDesc());

//        SessionUser user = (SessionUser) httpSession.getAttribute("user");

        if (user != null) {
            model.addAttribute("userName", user.getName());
        }
        return "index";
    }
```
`@LoginUser SessionUser user`ì²˜ëŸ¼  
`@LoginUser`ë§Œ ì“°ë©´ ì„¸ì…˜ ì •ë³´ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤!

<br>

## 5.5 ì„¸ì…˜ ì €ì¥ì†Œë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°
ì¶”ê°€ì ìœ¼ë¡œ ê°œì„ í•´ë³´ì!

ë¬¸ì œ :one: : ìš°ë¦¬ê°€ ë§Œë“  ì„œë¹„ìŠ¤ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ `ì¬ì‹¤í–‰í•˜ë©´ ë¡œê·¸ì¸ì´ í’€ë¦¼`
- ì™œ :question: ì´ëŠ” ì„¸ì…˜ì´ `ë‚´ì¥ í†°ìº£ì˜ ë©”ëª¨ë¦¬`ì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì´ë‹¤  
    - ê¸°ë³¸ì ìœ¼ë¡œ ì„¸ì…˜ì€ ì‹¤í–‰ë˜ëŠ” `WAS`ì˜ ë©”ëª¨ë¦¬ì—ì„œ ì €ì¥ë˜ê³  í˜¸ì¶œëœë‹¤!  
    - ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ë‹¤ ë³´ë‹ˆ ë‚´ì¥ í†°ìº£ì²˜ëŸ¼ `ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì‹¤í–‰ë˜ëŠ” êµ¬ì¡°ì—ì„ ` í•­ìƒ `ì´ˆê¸°í™”`ë¨  
    -> ì¦‰ ë°°í¬í•  ë•Œë§ˆë‹¤ í†°ìº£ì´ ì¬ì‹œì‘ë¨..


ë¬¸ì œ :two: : `2ëŒ€ ì´ìƒ`ì˜ ì„œë²„ì—ì„œ ì„œë¹„ìŠ¤í•˜ê³  ìˆë‹¤ë©´, `í†°ìº£ë§ˆë‹¤ ì„¸ì…˜ ë™ê¸°í™”` ì„¤ì •ì„ í•´ì¤˜ì•¼ í•œë‹¤.  
ê·¸ë˜ì„œ í˜„ì—…ì—ì„  `ì„¸ì…˜ ì €ì¥ì†Œ`ì— ëŒ€í•´ `3ê°€ì§€` ì¤‘ í•œ ê°€ì§€ ì„ íƒ!

1. í†°ìº£ ì„¸ì…˜ ì‚¬ìš©  
2. MySQL ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©  
3. Redis, Memcached ì™€ ê°™ì€ ë©”ëª¨ë¦¬ DBë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©  

<br>

ìš°ë¦¬ëŠ” ***2ë²ˆ*** ì„ ì„ íƒí•˜ì! ì„¤ì •ì´ ê°„ë‹¨í•˜ê³  ì‚¬ìš©ìê°€ ë§ì€ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆê³ , ë¹„ìš©ì ˆê°ì„ ìœ„í•´!  


<br>

## 5.6 ë„¤ì´ë²„ ë¡œê·¸ì¸ ì—°ë™í•˜ê¸°
<img width="944" alt="naver" src="https://github.com/wimmings/wimmings/assets/98014840/23968414-9183-4661-88d7-988c06a02624">

<img width="979" alt="naver2" src="https://github.com/wimmings/wimmings/assets/98014840/8ccb7a8d-c33a-467b-8ed4-55b274957634">

